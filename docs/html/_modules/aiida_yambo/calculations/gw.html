

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>aiida_yambo.calculations.gw &mdash; yambo-aiida 0.1.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="search" type="application/opensearchdescription+xml"
          title="Search within yambo-aiida 0.1.0 documentation"
          href="../../../_static/opensearch.xml"/>

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> yambo-aiida
          

          
          </a>

          
            
            
              <div class="version">
                0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../user_guide/get_started/index.html">Get started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user_guide/workflows/index.html">Workflows for AiiDA-Yambo</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../module_guide/index.html">Modules provided with aiida-yambo (API reference)</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">yambo-aiida</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>aiida_yambo.calculations.gw</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for aiida_yambo.calculations.gw</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Plugin to create a Yambo input file.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">aiida.engine</span> <span class="k">import</span> <span class="n">CalcJob</span>
<span class="kn">from</span> <span class="nn">aiida.common.exceptions</span> <span class="k">import</span> <span class="n">InputValidationError</span><span class="p">,</span> <span class="n">ValidationError</span>
<span class="kn">from</span> <span class="nn">aiida.common.datastructures</span> <span class="k">import</span> <span class="n">CalcInfo</span>
<span class="kn">from</span> <span class="nn">aiida.common.datastructures</span> <span class="k">import</span> <span class="n">CalcJobState</span>
<span class="kn">from</span> <span class="nn">aiida_quantumespresso.calculations</span> <span class="k">import</span> <span class="n">_lowercase_dict</span><span class="p">,</span> <span class="n">_uppercase_dict</span>
<span class="kn">from</span> <span class="nn">aiida.common.exceptions</span> <span class="k">import</span> <span class="n">UniquenessError</span><span class="p">,</span> <span class="n">InputValidationError</span>
<span class="kn">from</span> <span class="nn">aiida.common.utils</span> <span class="k">import</span> <span class="n">classproperty</span>
<span class="kn">from</span> <span class="nn">aiida.orm.nodes</span> <span class="k">import</span> <span class="n">Dict</span>
<span class="kn">from</span> <span class="nn">aiida.orm.nodes</span> <span class="k">import</span> <span class="n">RemoteData</span><span class="p">,</span> <span class="n">BandsData</span><span class="p">,</span> <span class="n">ArrayData</span>
<span class="kn">from</span> <span class="nn">aiida.plugins</span> <span class="k">import</span> <span class="n">DataFactory</span><span class="p">,</span> <span class="n">CalculationFactory</span>
<span class="kn">from</span> <span class="nn">aiida.orm</span> <span class="k">import</span> <span class="n">Code</span>
<span class="kn">from</span> <span class="nn">aiida.common</span> <span class="k">import</span> <span class="n">AIIDA_LOGGER</span>
<span class="kn">from</span> <span class="nn">aiida.common</span> <span class="k">import</span> <span class="n">LinkType</span>
<span class="kn">import</span> <span class="nn">six</span>
<span class="n">PwCalculation</span> <span class="o">=</span> <span class="n">CalculationFactory</span><span class="p">(</span><span class="s1">&#39;quantumespresso.pw&#39;</span><span class="p">)</span>

<span class="n">__authors__</span> <span class="o">=</span> <span class="s2">&quot; Gianluca Prandini (gianluca.prandini@epfl.ch),&quot;</span> \
              <span class="s2">&quot; Antimo Marrazzo (antimo.marrazzo@epfl.ch),&quot;</span> \
              <span class="s2">&quot; Michael Atambo (michaelontita.atambo@unimore.it).&quot;</span>


<div class="viewcode-block" id="YamboCalculation"><a class="viewcode-back" href="../../../module_guide/calculations.html#aiida_yambo.calculations.gw.YamboCalculation">[docs]</a><span class="k">class</span> <span class="nc">YamboCalculation</span><span class="p">(</span><span class="n">CalcJob</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    AiiDA plugin for the Yambo code.</span>
<span class="sd">    For more information, refer to http://www.yambo-code.org/</span>
<span class="sd">    https://github.com/yambo-code/yambo-aiida and http://aiida-yambo.readthedocs.io/en/latest/</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Default input and output files</span>
    <span class="n">_DEFAULT_INPUT_FILE</span> <span class="o">=</span> <span class="s1">&#39;aiida.in&#39;</span>
    <span class="n">_DEFAULT_OUTPUT_FILE</span> <span class="o">=</span> <span class="s1">&#39;aiida.out&#39;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">define</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span><span class="n">spec</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">YamboCalculation</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s1">&#39;metadata.options.input_filename&#39;</span><span class="p">,</span> <span class="n">valid_type</span><span class="o">=</span><span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">_DEFAULT_INPUT_FILE</span><span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s1">&#39;metadata.options.output_filename&#39;</span><span class="p">,</span> <span class="n">valid_type</span><span class="o">=</span><span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">_DEFAULT_OUTPUT_FILE</span><span class="p">)</span>

       <span class="c1"># Default output parser provided by AiiDA</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s1">&#39;metadata.options.parser_name&#39;</span><span class="p">,</span> <span class="n">valid_type</span><span class="o">=</span><span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;yambo.yambo&#39;</span><span class="p">)</span>

       <span class="c1"># self._SCRATCH_FOLDER = &#39;SAVE&#39;</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s1">&#39;metadata.options.scratch_folder&#39;</span><span class="p">,</span> <span class="n">valid_type</span><span class="o">=</span><span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;SAVE&#39;</span><span class="p">)</span>


        <span class="n">spec</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s1">&#39;metadata.options.logostring&#39;</span><span class="p">,</span> <span class="n">valid_type</span><span class="o">=</span><span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">#</span>
<span class="s2"># Y88b    /   e           e    e      888~~\    ,88~-_</span>
<span class="s2">#  Y88b  /   d8b         d8b  d8b     888   |  d888   </span><span class="se">\</span>
<span class="s2">#   Y88b/   /Y88b       d888bdY88b    888 _/  88888    |</span>
<span class="s2">#    Y8Y   /  Y88b     / Y88Y Y888b   888  \  88888    |</span>
<span class="s2">#     Y   /____Y88b   /   YY   Y888b  888   |  Y888   /</span>
<span class="s2">#    /   /      Y88b /          Y888b 888__/    `88_-~</span>
<span class="s2">#</span>
<span class="s2">#             AIIDA input plugin.  YAMBO 4.x compatible</span>
<span class="s2">#               http://www.yambo-code.org</span>
<span class="s2">#</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="p">)</span>


        <span class="n">spec</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s1">&#39;settings&#39;</span><span class="p">,</span><span class="n">valid_type</span><span class="o">=</span><span class="n">Dict</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Use an additional node for special settings&#39;</span><span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s1">&#39;parameters&#39;</span><span class="p">,</span><span class="n">valid_type</span><span class="o">=</span><span class="n">Dict</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Use a node that specifies the input parameters&#39;</span><span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s1">&#39;parent_folder&#39;</span><span class="p">,</span><span class="n">valid_type</span><span class="o">=</span><span class="n">RemoteData</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Use a remote folder as parent folder (for &quot;restarts and similar&quot;&#39;</span><span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s1">&#39;preprocessing_code&#39;</span><span class="p">,</span><span class="n">valid_type</span><span class="o">=</span><span class="n">Code</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Use a preprocessing code for starting yambo&#39;</span><span class="p">,</span><span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s1">&#39;precode_parameters&#39;</span><span class="p">,</span><span class="n">valid_type</span><span class="o">=</span><span class="n">Dict</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Use a node that specifies the input parameters for the yambo precode&#39;</span><span class="p">,</span><span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s1">&#39;code&#39;</span><span class="p">,</span><span class="n">valid_type</span><span class="o">=</span><span class="n">Code</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Use a main code for yambo calculation&#39;</span><span class="p">)</span>

        <span class="n">spec</span><span class="o">.</span><span class="n">exit_code</span><span class="p">(</span><span class="mi">300</span><span class="p">,</span> <span class="s1">&#39;ERROR_NO_RETRIEVED_FOLDER&#39;</span><span class="p">,</span>
                <span class="n">message</span><span class="o">=</span><span class="s1">&#39;The retrieved folder data node could not be accessed.&#39;</span><span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">exit_code</span><span class="p">(</span><span class="mi">301</span><span class="p">,</span> <span class="s1">&#39;WALLTIME_ERROR&#39;</span><span class="p">,</span>
                <span class="n">message</span><span class="o">=</span><span class="s1">&#39;time exceeded the max walltime&#39;</span><span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">exit_code</span><span class="p">(</span><span class="mi">302</span><span class="p">,</span> <span class="s1">&#39;NO_SUCCESS&#39;</span><span class="p">,</span>
                <span class="n">message</span><span class="o">=</span><span class="s1">&#39;failed calculation for some reason: could be a low number of conduction bands&#39;</span><span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">exit_code</span><span class="p">(</span><span class="mi">303</span><span class="p">,</span> <span class="s1">&#39;PARSER_ANOMALY&#39;</span><span class="p">,</span>
                <span class="n">message</span><span class="o">=</span><span class="s1">&#39;Unexpected behavior of YamboFolder&#39;</span><span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">exit_code</span><span class="p">(</span><span class="mi">304</span><span class="p">,</span> <span class="s1">&#39;PARA_ERROR&#39;</span><span class="p">,</span>
                <span class="n">message</span><span class="o">=</span><span class="s1">&#39;parallelization error&#39;</span><span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">exit_code</span><span class="p">(</span><span class="mi">305</span><span class="p">,</span> <span class="s1">&#39;MEMORY_ISSUE&#39;</span><span class="p">,</span>
                <span class="n">message</span><span class="o">=</span><span class="s1">&#39;memory issues&#39;</span><span class="p">)</span>


        <span class="c1">#outputs definition:</span>

        <span class="n">spec</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;output_parameters&#39;</span><span class="p">,</span> <span class="n">valid_type</span><span class="o">=</span><span class="n">Dict</span><span class="p">,</span>
                <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;returns the output parameters&#39;</span><span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;array_alpha&#39;</span><span class="p">,</span> <span class="n">valid_type</span><span class="o">=</span><span class="n">ArrayData</span><span class="p">,</span>
                <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;returns the alpha array&#39;</span><span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;array_alpha_bands&#39;</span><span class="p">,</span> <span class="n">valid_type</span><span class="o">=</span><span class="n">ArrayData</span><span class="p">,</span>
                <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;returns the alpha array bands&#39;</span><span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;array_alpha_array&#39;</span><span class="p">,</span> <span class="n">valid_type</span><span class="o">=</span><span class="n">ArrayData</span><span class="p">,</span>
                <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;returns the alpha array&#39;</span><span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;bands_quasiparticle&#39;</span><span class="p">,</span> <span class="n">valid_type</span><span class="o">=</span><span class="n">BandsData</span><span class="p">,</span>
                <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;returns the quasiparticle band structure&#39;</span><span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;array_qp&#39;</span><span class="p">,</span> <span class="n">valid_type</span><span class="o">=</span><span class="n">ArrayData</span><span class="p">,</span>
                <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;returns the quasiparticle array band structure&#39;</span><span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;array_eels&#39;</span><span class="p">,</span> <span class="n">valid_type</span><span class="o">=</span><span class="n">ArrayData</span><span class="p">,</span>
                <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;returns the eels array&#39;</span><span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;array_eps&#39;</span><span class="p">,</span> <span class="n">valid_type</span><span class="o">=</span><span class="n">ArrayData</span><span class="p">,</span>
                <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;returns the eps array&#39;</span><span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;array_ndb&#39;</span><span class="p">,</span> <span class="n">valid_type</span><span class="o">=</span><span class="n">ArrayData</span><span class="p">,</span>
                <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;returns the array for ndb&#39;</span><span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;array_ndb_QP&#39;</span><span class="p">,</span> <span class="n">valid_type</span><span class="o">=</span><span class="n">ArrayData</span><span class="p">,</span>
                <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;returns the array for ndbQP&#39;</span><span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;array_ndb_HFlocXC&#39;</span><span class="p">,</span> <span class="n">valid_type</span><span class="o">=</span><span class="n">ArrayData</span><span class="p">,</span>
                <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;returns the array ndb for HFlocXC&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="YamboCalculation.prepare_for_submission"><a class="viewcode-back" href="../../../module_guide/calculations.html#aiida_yambo.calculations.gw.YamboCalculation.prepare_for_submission">[docs]</a>    <span class="k">def</span> <span class="nf">prepare_for_submission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tempfolder</span><span class="p">):</span>

        <span class="n">local_copy_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">remote_copy_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">remote_symlink_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Settings can be undefined, and defaults to an empty dictionary.</span>
        <span class="c1"># They will be used for any input that doen&#39;t fit elsewhere.</span>

        <span class="n">settings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">get_dict</span><span class="p">()</span>

        <span class="n">initialise</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;INITIALISE&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">initialise</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">initialise</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">InputValidationError</span><span class="p">(</span><span class="s2">&quot;INITIALISE must be &quot;</span> <span class="s2">&quot; a boolean&quot;</span><span class="p">)</span>

        <span class="n">parent_db</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;PARENT_DB&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">parent_db</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parent_db</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">InputValidationError</span><span class="p">(</span><span class="s2">&quot;PARENT_DB must be &quot;</span> <span class="s2">&quot; a boolean&quot;</span><span class="p">)</span>

        <span class="n">hard_link</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;HARD_LINK&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hard_link</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hard_link</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">InputValidationError</span><span class="p">(</span><span class="s2">&quot;HARD_LINK must be &quot;</span> <span class="s2">&quot; a boolean&quot;</span><span class="p">)</span>

        <span class="n">hard_link_DB</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;HARD_LINK_DB&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hard_link_DB</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hard_link_DB</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">InputValidationError</span><span class="p">(</span><span class="s2">&quot;HARD_LINK_DB must be &quot;</span> <span class="s2">&quot; a boolean&quot;</span><span class="p">)</span>

        <span class="n">parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">parameters</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">initialise</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">Dict</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">InputValidationError</span><span class="p">(</span><span class="s2">&quot;parameters is not of type Dict&quot;</span><span class="p">)</span>

        <span class="n">parent_calc_folder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">parent_folder</span>

        <span class="n">main_code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">code</span>

        <span class="n">preproc_code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">preprocessing_code</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">parent_calc</span> <span class="o">=</span> <span class="n">parent_calc_folder</span><span class="o">.</span><span class="n">get_incoming</span><span class="p">()</span><span class="o">.</span><span class="n">all_nodes</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="c1">#to load the node from a workchain...</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">parent_calc</span> <span class="o">=</span> <span class="n">parent_calc_folder</span><span class="o">.</span><span class="n">get_incoming</span><span class="p">()</span><span class="o">.</span><span class="n">get_node_by_label</span><span class="p">(</span><span class="s1">&#39;remote_folder&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">parent_calc</span><span class="o">.</span><span class="n">process_type</span><span class="o">==</span><span class="s1">&#39;aiida.calculations:yambo.yambo&#39;</span><span class="p">:</span>
            <span class="n">yambo_parent</span><span class="o">=</span><span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">yambo_parent</span><span class="o">=</span><span class="kc">False</span>

        <span class="c1"># flags for yambo interfaces</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">precode_param_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">precode_parameters</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">precode_param_dict</span> <span class="o">=</span> <span class="n">Dict</span><span class="p">(</span><span class="nb">dict</span><span class="o">=</span><span class="p">{})</span>
        <span class="c1"># check the precode parameters given in input</span>
        <span class="n">input_cmdline</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;CMDLINE&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="kn">import</span> <span class="nn">re</span>
        <span class="n">precode_params_list</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1">#[&#39;cd aiida.save&#39;] ##.format(parent_calc_folder._PREFIX)</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(^\-)([a-zA-Z])&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">precode_param_dict</span><span class="o">.</span><span class="n">get_dict</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;-O&#39;</span> <span class="ow">or</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;-H&#39;</span> <span class="ow">or</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;-h&#39;</span> <span class="ow">or</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;-F&#39;</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">InputValidationError</span><span class="p">(</span>
                        <span class="s2">&quot;Precode flag </span><span class="si">{}</span><span class="s2"> is not allowed&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">precode_param_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">precode_params_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
                    <span class="k">elif</span> <span class="n">precode_param_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">precode_params_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)))</span>
                        <span class="n">precode_params_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">InputValidationError</span><span class="p">(</span>
                    <span class="s2">&quot;Wrong format of precode_parameters&quot;</span><span class="p">)</span>
        <span class="c1"># Adding manual cmdline input (e.g. for DB fragmentation)</span>
        <span class="k">if</span> <span class="n">input_cmdline</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">precode_params_list</span> <span class="o">=</span> <span class="n">precode_params_list</span> <span class="o">+</span> <span class="n">input_cmdline</span>

        <span class="c1"># TODO: check that remote data must be on the same computer</span>

        <span class="c1">##############################</span>
        <span class="c1"># END OF INITIAL INPUT CHECK #</span>
        <span class="c1">##############################</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">initialise</span><span class="p">:</span>
            <span class="c1">###################################################</span>
            <span class="c1"># Prepare yambo input file</span>
            <span class="c1">###################################################</span>

            <span class="n">params_dict</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get_dict</span><span class="p">()</span>

            <span class="c1"># extract boolean keys</span>
            <span class="n">boolean_dict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">k</span><span class="p">:</span> <span class="n">v</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">params_dict</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="n">params_dict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">k</span><span class="p">:</span> <span class="n">v</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">params_dict</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">boolean_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="p">}</span>

            <span class="c1"># reorganize the dictionary and create a list of dictionaries with key, value and units</span>
            <span class="n">parameters_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">params_dict</span><span class="p">):</span>

                <span class="k">if</span> <span class="s2">&quot;_units&quot;</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">units_key</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_units&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">units</span> <span class="o">=</span> <span class="n">params_dict</span><span class="p">[</span><span class="n">units_key</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="n">units</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="n">this_dict</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">this_dict</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span>
                <span class="n">this_dict</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
                <span class="n">this_dict</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">units</span>

                <span class="n">parameters_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">this_dict</span><span class="p">)</span>

            <span class="n">input_filename</span> <span class="o">=</span> <span class="n">tempfolder</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">input_filename</span><span class="p">)</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">input_filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">infile</span><span class="p">:</span>
                <span class="n">infile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">logostring</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">boolean_dict</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">v</span><span class="p">:</span>
                        <span class="n">infile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>

                <span class="k">for</span> <span class="n">this_dict</span> <span class="ow">in</span> <span class="n">parameters_list</span><span class="p">:</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">this_dict</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">]</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">this_dict</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
                    <span class="n">units</span> <span class="o">=</span> <span class="n">this_dict</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span>


                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="n">value_string</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                                <span class="n">value_string</span> <span class="o">+=</span> <span class="s2">&quot; | &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">v</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot; |</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">value_string</span> <span class="o">+=</span> <span class="s2">&quot; | &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">value</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot; |</span><span class="se">\n</span><span class="s2">&quot;</span>

                        <span class="n">the_string</span> <span class="o">=</span> <span class="s2">&quot;% </span><span class="si">{}</span><span class="se">\n</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value_string</span><span class="p">)</span>
                        <span class="n">the_string</span> <span class="o">+=</span> <span class="s2">&quot;%&quot;</span>


                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">the_value</span> <span class="o">=</span> <span class="s1">&#39;&quot;</span><span class="si">{}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span>
                            <span class="n">value</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                        <span class="n">the_string</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">the_value</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">units</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">the_string</span> <span class="o">+=</span> <span class="s2">&quot; </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>

                    <span class="n">infile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">the_string</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1">############################################</span>
        <span class="c1"># set copy of the parent calculation</span>
        <span class="c1">############################################</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">parent_calc</span> <span class="o">=</span> <span class="n">parent_calc_folder</span><span class="o">.</span><span class="n">get_incoming</span><span class="p">()</span><span class="o">.</span><span class="n">all_nodes</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="c1">#to load the node from a workchain...</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">parent_calc</span> <span class="o">=</span> <span class="n">parent_calc_folder</span><span class="o">.</span><span class="n">get_incoming</span><span class="p">()</span><span class="o">.</span><span class="n">get_node_by_label</span><span class="p">(</span><span class="s1">&#39;remote_folder&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">yambo_parent</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">hard_link</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">remote_copy_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">parent_calc_folder</span><span class="o">.</span><span class="n">computer</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span><span class="n">parent_calc_folder</span><span class="o">.</span><span class="n">get_remote_path</span><span class="p">()</span><span class="o">+</span><span class="s2">&quot;/SAVE/&quot;</span><span class="p">,</span><span class="s1">&#39;./SAVE/&#39;</span><span class="p">))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">remote_copy_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">parent_calc_folder</span><span class="o">.</span><span class="n">computer</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span><span class="n">parent_calc_folder</span><span class="o">.</span><span class="n">get_remote_path</span><span class="p">()</span><span class="o">+</span><span class="s2">&quot;out/aiida.save/SAVE/&quot;</span><span class="p">,</span><span class="s1">&#39;./SAVE/&#39;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">remote_symlink_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">parent_calc_folder</span><span class="o">.</span><span class="n">computer</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span><span class="n">parent_calc_folder</span><span class="o">.</span><span class="n">get_remote_path</span><span class="p">()</span><span class="o">+</span><span class="s2">&quot;/SAVE/&quot;</span><span class="p">,</span><span class="s1">&#39;./SAVE/&#39;</span><span class="p">))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">remote_symlink_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">parent_calc_folder</span><span class="o">.</span><span class="n">computer</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span><span class="n">parent_calc_folder</span><span class="o">.</span><span class="n">get_remote_path</span><span class="p">()</span><span class="o">+</span><span class="s2">&quot;out/aiida.save/SAVE/&quot;</span><span class="p">,</span><span class="s1">&#39;./SAVE/&#39;</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">hard_link_DB</span><span class="p">:</span>
                    <span class="n">remote_copy_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">parent_calc_folder</span><span class="o">.</span><span class="n">computer</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span><span class="n">parent_calc_folder</span><span class="o">.</span><span class="n">get_remote_path</span><span class="p">()</span><span class="o">+</span><span class="s2">&quot;/aiida.out/&quot;</span><span class="p">,</span><span class="s1">&#39;./aiida.out/&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">parent_db</span><span class="p">:</span>
                <span class="n">remote_symlink_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">parent_calc_folder</span><span class="o">.</span><span class="n">computer</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span><span class="n">parent_calc_folder</span><span class="o">.</span><span class="n">get_remote_path</span><span class="p">()</span><span class="o">+</span><span class="s2">&quot;/aiida.out/&quot;</span><span class="p">,</span><span class="s1">&#39;./aiida.out/&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#remote_copy_list.append((parent_calc_folder.computer.uuid,parent_calc_folder.get_remote_path()+&quot;out/aiida.save/*&quot;,&#39;.&#39;)) ##.format(parent_calc_folder._PREFIX)</span>
            <span class="n">remote_copy_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">(</span><span class="n">parent_calc_folder</span><span class="o">.</span><span class="n">computer</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                 <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parent_calc_folder</span><span class="o">.</span><span class="n">get_remote_path</span><span class="p">(),</span>
                              <span class="n">PwCalculation</span><span class="o">.</span><span class="n">_OUTPUT_SUBFOLDER</span><span class="p">,</span>
                              <span class="s2">&quot;aiida.save&quot;</span><span class="p">,</span><span class="s2">&quot;*&quot;</span> <span class="p">),</span>  <span class="c1">##.format(parent_calc_folder._PREFIX)</span>
                                     <span class="s2">&quot;.&quot;</span>
                                     <span class="p">)</span>
                                    <span class="p">)</span>
        <span class="c1">############################################</span>
        <span class="c1"># set Calcinfo</span>
        <span class="c1">############################################</span>

        <span class="n">calcinfo</span> <span class="o">=</span> <span class="n">CalcInfo</span><span class="p">()</span>

        <span class="n">calcinfo</span><span class="o">.</span><span class="n">uuid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uuid</span>

        <span class="n">calcinfo</span><span class="o">.</span><span class="n">local_copy_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">calcinfo</span><span class="o">.</span><span class="n">remote_copy_list</span> <span class="o">=</span> <span class="n">remote_copy_list</span>
        <span class="n">calcinfo</span><span class="o">.</span><span class="n">remote_symlink_list</span> <span class="o">=</span> <span class="n">remote_symlink_list</span>

        <span class="c1"># Retrieve by default the output file and the xml file</span>
        <span class="n">calcinfo</span><span class="o">.</span><span class="n">retrieve_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">calcinfo</span><span class="o">.</span><span class="n">retrieve_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;r*&#39;</span><span class="p">)</span>
        <span class="n">calcinfo</span><span class="o">.</span><span class="n">retrieve_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;l*&#39;</span><span class="p">)</span>
        <span class="n">calcinfo</span><span class="o">.</span><span class="n">retrieve_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;o*&#39;</span><span class="p">)</span>
        <span class="n">calcinfo</span><span class="o">.</span><span class="n">retrieve_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;LOG/l-*_CPU_1&#39;</span><span class="p">)</span>
        <span class="n">extra_retrieved</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span>
            <span class="s1">&#39;ADDITIONAL_RETRIEVE_LIST&#39;</span><span class="p">,</span>
            <span class="p">[</span><span class="s1">&#39;aiida.out/ndb.QP&#39;</span><span class="p">,</span> <span class="s1">&#39;aiida.out/ndb.HF_and_locXC&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">extra</span> <span class="ow">in</span> <span class="n">extra_retrieved</span><span class="p">:</span>
            <span class="n">calcinfo</span><span class="o">.</span><span class="n">retrieve_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">extra</span><span class="p">)</span>

        <span class="kn">from</span> <span class="nn">aiida.common.datastructures</span> <span class="k">import</span> <span class="n">CodeRunMode</span><span class="p">,</span> <span class="n">CodeInfo</span>

        <span class="c1"># c1 = interface dft codes and yambo (ex. p2y or a2y)</span>
        <span class="n">c1</span> <span class="o">=</span> <span class="n">CodeInfo</span><span class="p">()</span>
        <span class="n">c1</span><span class="o">.</span><span class="n">withmpi</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">c1</span><span class="o">.</span><span class="n">cmdline_params</span> <span class="o">=</span> <span class="n">precode_params_list</span>

        <span class="c1"># c2 = yambo initialization</span>
        <span class="n">c2</span> <span class="o">=</span> <span class="n">CodeInfo</span><span class="p">()</span>
        <span class="n">c2</span><span class="o">.</span><span class="n">withmpi</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">c2</span><span class="o">.</span><span class="n">cmdline_params</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">c2</span><span class="o">.</span><span class="n">code_uuid</span> <span class="o">=</span> <span class="n">main_code</span><span class="o">.</span><span class="n">uuid</span>

        <span class="c1"># if the parent calculation is a yambo calculation skip the interface (c1) and the initialization (c2)</span>
        <span class="k">if</span> <span class="n">yambo_parent</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">parent_settings</span> <span class="o">=</span> <span class="n">_uppercase_dict</span><span class="p">(</span>
                    <span class="n">parent_calc</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">get_dict</span><span class="p">(),</span>
                    <span class="n">dict_name</span><span class="o">=</span><span class="s1">&#39;parent settings&#39;</span><span class="p">)</span>
                <span class="n">parent_initialise</span> <span class="o">=</span> <span class="n">parent_settings</span><span class="p">[</span><span class="s1">&#39;INITIALISE&#39;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">parent_initialise</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">c1</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">parent_initialise</span><span class="p">:</span>
                <span class="n">c2</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">c1</span><span class="o">.</span><span class="n">cmdline_params</span> <span class="o">=</span> <span class="n">precode_params_list</span>
            <span class="n">c1</span><span class="o">.</span><span class="n">code_uuid</span> <span class="o">=</span> <span class="n">preproc_code</span><span class="o">.</span><span class="n">uuid</span>

        <span class="c1"># c3 = yambo calculation</span>
        <span class="n">c3</span> <span class="o">=</span> <span class="n">CodeInfo</span><span class="p">()</span>
        <span class="n">c3</span><span class="o">.</span><span class="n">withmpi</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1">#c3.withmpi = self.get_withmpi()</span>
        <span class="n">c3</span><span class="o">.</span><span class="n">cmdline_params</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;-F&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">input_filename</span><span class="p">,</span> \
            <span class="s1">&#39;-J&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">output_filename</span><span class="p">,</span> \
        <span class="p">]</span>
        <span class="n">c3</span><span class="o">.</span><span class="n">code_uuid</span> <span class="o">=</span> <span class="n">main_code</span><span class="o">.</span><span class="n">uuid</span>

        <span class="k">if</span> <span class="n">initialise</span><span class="p">:</span>
            <span class="n">c2</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">c3</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1">#logic of the execution</span>
        <span class="c1">#calcinfo.codes_info = [c1, c2, c3] if not yambo_parent else [c3]</span>
        <span class="k">if</span> <span class="n">yambo_parent</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">parent_initialise</span><span class="p">:</span>
                <span class="n">calcinfo</span><span class="o">.</span><span class="n">codes_info</span> <span class="o">=</span> <span class="p">[</span><span class="n">c3</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">calcinfo</span><span class="o">.</span><span class="n">codes_info</span> <span class="o">=</span> <span class="p">[</span><span class="n">c2</span><span class="p">,</span> <span class="n">c3</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">initialise</span><span class="p">:</span>
            <span class="n">calcinfo</span><span class="o">.</span><span class="n">codes_info</span> <span class="o">=</span> <span class="p">[</span><span class="n">c1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">calcinfo</span><span class="o">.</span><span class="n">codes_info</span> <span class="o">=</span> <span class="p">[</span><span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c3</span><span class="p">]</span>

        <span class="n">calcinfo</span><span class="o">.</span><span class="n">codes_run_mode</span> <span class="o">=</span> <span class="n">CodeRunMode</span><span class="o">.</span><span class="n">SERIAL</span>

        <span class="k">if</span> <span class="n">settings</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InputValidationError</span><span class="p">(</span>
                <span class="s2">&quot;The following keys have been found in &quot;</span>
                <span class="s2">&quot;the settings input node, but were not understood: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">keys</span><span class="p">()))))</span>

        <span class="k">return</span> <span class="n">calcinfo</span></div>

<span class="c1">################################################################################</span>
    <span class="c1">#the following functions are not used, so why are they here?</span>
    <span class="k">def</span> <span class="nf">_check_valid_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">calc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check that calc is a valid parent for a YamboCalculation.</span>
<span class="sd">        It can be a PwCalculation or a YamboCalculation.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">((</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">calc</span><span class="p">,</span> <span class="n">PwCalculation</span><span class="p">))</span>
                    <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">calc</span><span class="p">,</span> <span class="n">YamboCalculation</span><span class="p">))):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Parent calculation must be a PwCalculation or a YamboCalculation&quot;</span>
                <span class="p">)</span>

        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">((</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">calc</span><span class="p">,</span> <span class="n">PwCalculation</span><span class="p">))</span>
                    <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">calc</span><span class="p">,</span> <span class="n">YamboCalculation</span><span class="p">))):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Parent calculation must be a PwCalculation or a YamboCalculation&quot;</span>
                <span class="p">)</span>

<div class="viewcode-block" id="YamboCalculation.use_parent_calculation"><a class="viewcode-back" href="../../../module_guide/calculations.html#aiida_yambo.calculations.gw.YamboCalculation.use_parent_calculation">[docs]</a>    <span class="k">def</span> <span class="nf">use_parent_calculation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">calc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the parent calculation of Yambo,</span>
<span class="sd">        from which it will inherit the outputsubfolder.</span>
<span class="sd">        The link will be created from parent RemoteData to YamboCalculation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">aiida.common.exceptions</span> <span class="k">import</span> <span class="n">NotExistent</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_check_valid_parent</span><span class="p">(</span><span class="n">calc</span><span class="p">)</span>

        <span class="n">remotedatas</span> <span class="o">=</span> <span class="n">calc</span><span class="o">.</span><span class="n">get_outputs</span><span class="p">(</span><span class="n">node_type</span><span class="o">=</span><span class="n">RemoteData</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">remotedatas</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NotExistent</span><span class="p">(</span><span class="s2">&quot;No output remotedata found in &quot;</span> <span class="s2">&quot;the parent&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">remotedatas</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">UniquenessError</span><span class="p">(</span><span class="s2">&quot;More than one output remotedata found in &quot;</span>
                                  <span class="s2">&quot;the parent&quot;</span><span class="p">)</span>
        <span class="n">remotedata</span> <span class="o">=</span> <span class="n">remotedatas</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_set_parent_remotedata</span><span class="p">(</span><span class="n">remotedata</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_set_parent_remotedata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">remotedata</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Used to set a parent remotefolder in the start of Yambo.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">remotedata</span><span class="p">,</span> <span class="n">RemoteData</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;remotedata must be a RemoteData&#39;</span><span class="p">)</span>

        <span class="c1"># complain if another remotedata is already found</span>
        <span class="n">input_remote</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_inputs</span><span class="p">(</span><span class="n">node_type</span><span class="o">=</span><span class="n">RemoteData</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">input_remote</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;Cannot set several parent calculation to a &quot;</span>
                                  <span class="s2">&quot;Yambo calculation&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">use_parent_folder</span><span class="p">(</span><span class="n">remotedata</span><span class="p">)</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015-2020, ECOLE POLYTECHNIQUE FEDERALE DE LAUSANNE (Theory and Simulation of Materials (THEOS) and National Centre for Computational Design and Discovery of Novel Materials (NCCR MARVEL)), Switzerland and CNR NANO Modena, Italy. All rights reserved.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>